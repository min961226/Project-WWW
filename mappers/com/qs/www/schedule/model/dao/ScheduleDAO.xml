<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ScheduleDAO">

	<resultMap type="com.qs.www.schedule.model.dto.ReportDTO" id="reportResultMap">
		<result property="reportNo" column="REPORT_NO" />
		<result property="reportDate" column="REPORT_DATE" />
		<result property="memberNo" column="MEMBER_NO" />
		<result property="documentNo" column="DOCUMENT_NO" />
		<result property="reportNote" column="REPORT_NOTE" />
		<result property="reportStatus" column="REPORT_STATUS" />
		<result property="lineName" column="LINE_NAME" />
		<result property="reportTitle" column="REPORT_TITLE" />
	</resultMap>
	
	<resultMap type="com.qs.www.schedule.model.dto.OvertimeLogDTO" id="overtimeResultMap">
		<id property="memberOvertimeLogNo" column="MEMBER_OVERTIME_LOG_NO"/>
		<result property="overtimeReportNo" column="OVERTIME_REPORT_NO"/>
		<result property="overtimeStartDay" column="OVERTIME_START_DAY"/>
		<result property="overtimeStartTime" column="OVERTIME_START_TIME"/>
		<result property="overtimeEndDay" column="OVERTIME_END_DAY"/>
		<result property="overtimeEndTime" column="OVERTIME_END_TIME"/>
		<result property="overtimeDuring" column="OVERTIME_DURING"/>
		<result property="transBill" column="TRANS_BILL"/>
	</resultMap>
	
	<insert id="applyWorkingSystem" parameterType="com.qs.www.schedule.model.dto.ReportDTO">
	INSERT /* com.qs.www.schedule.model.dao.ScheduleDAO#applyWorkingSystem() */
	  INTO TBL_REPORT A
	(
	  A.REPORT_NO
	, A.REPORT_DATE
	, A.MEMBER_NO
	, A.DOCUMENT_NO
	, A.REPORT_NOTE
	, A.REPORT_STATUS
	, A.LINE_NAME
	, A.REPORT_TITLE
	)
	VALUES
	(
	  SEQ_REPORT_NO.NEXTVAL
	, SYSDATE
	, #{ memberNo }
	, #{ documentNo }
	, #{ reportNote }
	, DEFAULT
	, #{ lineName }
	, #{ reportTitle }
	)
	</insert>

	
	<insert id="applyWorkingSystemItemContent" parameterType="com.qs.www.schedule.model.dto.WorkingDocumentItemDTO">
	INSERT /* com.qs.www.schedule.model.dao.ScheduleDAO#applyWorkingSystemItemContent() */
	  INTO TBL_ITEM_CONTENT A
	(
	  A.REPORT_NO
	, A.DOCUMENT_NO
	, A.PRIORITY
	, A.ITEM_CONTENT
	)
	VALUES
	(
	  #{ reportNo }
	, #{ documentNo }
	, #{ priority }
	, #{ itemContent }
	)
	</insert>
	

	<insert id="applyWorkingSystemApprover" parameterType="com.qs.www.schedule.model.dto.ApproverPerReportDTO">
	INSERT /* com.qs.www.schedule.model.dao.ScheduleDAO#applyWorkingSystemApprover() */
	  INTO TBL_APPROVER_PER_REPORT A
	(
	  A.REPORT_NO
	, A.MEMBER_NO
	, A.PRIORITY
	, A.APPROVER_TYPE
	)
	VALUES
	(
	  #{ reportNo }
	, #{ memberNo }
	, #{ priority }
	, DEFAULT
	)
	</insert>
	
	<insert id="applyWorkingSystemReferer" parameterType="com.qs.www.schedule.model.dto.ApproverPerReportDTO">
	INSERT /* com.qs.www.schedule.model.dao.ScheduleDAO#applyWorkingSystemApprover() */
	  INTO TBL_APPROVER_PER_REPORT A
	(
	  A.REPORT_NO
	, A.MEMBER_NO
	, A.APPROVER_TYPE
	)
	VALUES
	(
	  #{ reportNo }
	, #{ memberNo }
	, #{ approverType }
	)
	</insert>
	
	<insert id="applyWorkingSystemMemberWorkLog" parameterType="com.qs.www.schedule.model.dto.MemberWorkLogDTO">
	INSERT /* com.qs.www.schedule.model.dao.ScheduleDAO#applyWorkingSystemMemberWorkLog() */
	  INTO TBL_MEMBER_WORK_LOG A
	(
	  A.MEMBER_WORK_LOG_NO
	, A.MEMBER_NO
	, A.WORK_TYPE
	, A.WORK_NO
	, A.CHANGE_DATE
	, A.CHANGE_REASON
	)
	VALUES
	(
	  SEQ_MEMBER_WORK_LOG_NO.NEXTVAL
	, #{ memberNo }
	, #{ workType }
	, #{ workNo }
	, #{ startDay }
	, #{ changeReason }
	)
	</insert>
  
	<update id="setFirstWorkingSystemApprover">
		UPDATE /* com.qs.www.approval.model.dao.ApprovalDAO#selectOneReportDetail()*/
		       TBL_APPROVER_PER_REPORT A
		   SET A.APPROVER_TYPE = '대기'
		 WHERE A.REPORT_NO = #{ reportNo }
		   AND A.PRIORITY = 1
	</update>
	
	<select id="selectMyWorkReport" resultMap="reportResultMap">
	SELECT /* com.qs.www.schedule.model.dao.ScheduleDAO#selectMyWorkReport() */
	       A.REPORT_NO
	     , A.REPORT_DATE
	     , A.MEMBER_NO
	     , A.DOCUMENT_NO
	     , A.REPORT_NOTE
	     , A.REPORT_STATUS
	     , A.LINE_NAME
	     , A.REPORT_TITLE
	  FROM TBL_REPORT A
	 WHERE A.MEMBER_NO = #{ no }
	   AND A.DOCUMENT_NO IN (4, 5)
	   AND REPORT_STATUS != '회수'
	 ORDER BY A.REPORT_NO DESC
	</select>
	
	<select id="countLateTimeNum" parameterType="com.qs.www.schedule.model.dto.MonthlyWorkLogDTO" resultType="_int">
	SELECT /* com.qs.www.schedule.model.dao.ScheduleDAO#countLateTimeNum() */
	       COUNT(*)
	  FROM TBL_DAILY_WORK_LOG A
	 WHERE A.MEMBER_NO = #{ memberNo }
	   AND A.DAILY_WORK_STATE = '지각'
	   AND A.WORK_DATE BETWEEN #{ monthStartDate } AND #{ monthEndDate }
	</select>
	
	<select id="countNoCheckInTimeNum" parameterType="com.qs.www.schedule.model.dto.MonthlyWorkLogDTO" resultType="_int">
	SELECT
	       COUNT(*)
	  FROM TBL_COMMUTE A
	 WHERE A.MEMBER_NO = #{ memberNo }
	   AND A.YEAR_MONTH = #{ monthAndYear }
	   AND A.IN_TIME IS NULL	
	</select>
	
	<select id="countNoCheckOutTimeNum" parameterType="com.qs.www.schedule.model.dto.MonthlyWorkLogDTO" resultType="_int">
	SELECT
	       COUNT(*)
	  FROM TBL_COMMUTE A
	 WHERE A.MEMBER_NO = #{ memberNo }
	   AND A.YEAR_MONTH = #{ monthAndYear }
	   AND A.OUT_TIME IS NULL	
	</select>
	
	<select id="checkedOutToday" parameterType="com.qs.www.schedule.model.dto.MonthlyWorkLogDTO" resultType="_int">
	SELECT
	       COUNT(*)
	  FROM TBL_COMMUTE A
	 WHERE A.MEMBER_NO = #{ memberNo }
	   AND (A.YEAR_MONTH || '-' || A.DAY) = #{ selectedDate }
	   AND A.OUT_TIME IS NULL
	</select>
	
	<select id="selectOverTimeLog" parameterType="com.qs.www.schedule.model.dto.OvertimeLogDTO" resultMap="overtimeResultMap">
	SELECT
	       A.MEMBER_OVERTIME_LOG_NO
	     , A.OVERTIME_REPORT_NO
	     , A.MEMBER_NO
	     , A.OVERTIME_START_DAY
	     , A.OVERTIME_START_TIME
	     , A.OVERTIME_END_DAY
	     , A.OVERTIME_END_TIME
	     , A.OVERTIME_DURING
	     , A.TRANS_BILL
	  FROM TBL_MEMBER_OVERTIME_LOG A
	 WHERE A.MEMBER_NO = #{ memberNo }
	   AND A.OVERTIME_START_DAY BETWEEN #{ weekStartDate } AND #{ weekEndDate }
	</select>

</mapper>